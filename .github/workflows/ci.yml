name: CI

on:
    push:
        branches: [main, master]
    pull_request:
        branches: [main, master]

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - uses: nixbuild/nix-quick-install-action@v34

            - name: Setup Nix path
              run: echo "NIX_PATH=nixpkgs=channel:nixos-unstable" >> $GITHUB_ENV

            - name: Restore and cache Nix store
              uses: nix-community/cache-nix-action@v6.1.3
              with:
                  primary-key: nix-${{ runner.os }}-${{ hashFiles('shell.nix') }}

            - name: Build
              run: nix-shell --run "go build ./..."

            - name: Test
              run: nix-shell --run "go test -v -cover ./..."

            - name: Vet
              run: nix-shell --run "go vet ./..."
